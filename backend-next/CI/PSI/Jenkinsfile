podTemplate(label: 'docker',
 containers: [containerTemplate(name: 'docker', image: 'docker:18.02-git', ttyEnabled: true, command: 'cat'), containerTemplate(name: 'helm', image: 'encima/helm-kubectl-git', ttyEnabled: true, command: 'cat')],
 volumes: [hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock')]
) {
 node('docker') {
  container('docker') {
   stage('Checkout') {
    checkout scm
   }
   stage('Build Docker') {
    sh 'ls -ahl server/'
    withCredentials([usernamePassword(credentialsId: 'git', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
     // available as an env variable, but will be masked if you try to print it out any which way
     // also available as a Groovy variableâ€”note double quotes for string interpolation
     echo "$USERNAME"
     echo "$PASSWORD"
     sh "git clone https://$USERNAME:$PASSWORD@git.psi.ch/MELANIE/catamel-psisecrets.git"
     sh "git clone https://$USERNAME:$PASSWORD@git.psi.ch/MELANIE/catamel-psiconfig.git"
     sh "mkdir -p CI/PSI/envfiles"
     sh "cp catamel-psisecrets/server/pass-db-qa/datasources_new.json CI/PSI/envfiles/datasources.json"
     sh "cp catamel-psisecrets/server/providers.json CI/PSI/envfiles/providers.json"
     sh "cp catamel-psisecrets/server/settings.json CI/PSI/envfiles/settings.json"
     sh "cp catamel-psiconfig/server/config.local.js CI/PSI/envfiles/config.local.js"
    }
    sh 'docker build -f CI/PSI/Dockerfile.test . -t catamel_test'
   }
   stage('SuperTest Catamel ') {
    sh 'docker run  --privileged -t catamel_test'
   }
   stage('Build release') {
    withCredentials([usernamePassword(credentialsId: 'dockerpsi', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
     sh "docker login registry.psi.ch:5000 -u $USERNAME -p $PASSWORD"
     def tag = sh(script: 'git rev-parse HEAD', returnStdout: true)
     sh "docker build . -t registry.psi.ch:5000/jenkins/dacatapiserver:$tag"
     sh "docker push registry.psi.ch:5000/jenkins/dacatapiserver:$tag"
    }
   }
  }
  container('helm') {
   stage('Release') {
    def workspace = pwd()
    sh "export KUBECONFIG=${workspace}@catamel-psisecrets/server/kubernetes/admin.conf"
    sh 'kubectl version'
    sh 'helm version'
    // sh 'helm del --purge dacat-api-server-development'
    def tag = sh(script: 'git rev-parse HEAD', returnStdout: true)
    sh "helm install catamel-psiconfig/server/kubernetes/helm/dacat-api-server --namespace=development --name=dacat-api-server-development --set image.tag=$tag"
   }
  }
 }
}