
# Data Catalog Backend
The data catalog backend is based on [NoSQL database MongoDB](https://www.mongodb.com/), [the Node based web application framework Express](http://expressjs.com/) and [the API framework Loopback](http://loopback.io/) technology stack (the "MEL" part of the "MELANIE" technology stack). It provides a REST based API which allows to store information about datasets and to allow to answer queries about the stored meta data for these datasets

# Getting started

## Prerequisites
You need to setup a MongoDB server. E.g. on a Redhat Linux System the following command will suffice

```
yum install mongodb-org-server
```

The needed database will be created automatically when the API server starts. Follow this [description](https://docs.mongodb.com/manual/tutorial/enable-authentication/) to enable authenticated access to the Mongo DB.

You will also require a RabbitMQ instance installed on your system. The production deployment will use its own in the Kubernetes cloud but it is required for local setup. Files can be dowlnloaded [here](http://www.rabbitmq.com/install-rpm.html).

```
dnf install erlang
```
Download rpm

```
rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc
        yum install rabbitmq-server-3.6.10-1.noarch.rpm
systemctl start rabbitmq-server
```

## Get code
```
git clone https://gitlab.psi.ch/MELANIE/catamel.git
cd catamel
npm install
```

## adjust Configuration
Add a datasources.local.json file inside server directory with connection data to your mongodb instance

```
server/datasources.local.json e.g.
{
  "mongo": {
    "host": "mongodbprod.my.site",
    "user": "dacatDBAdmin",
    "password": "myverysecretPW"
  }
}

```

## Start API server
```
node .
```

## initialize admin , archiveManager and ingestor accounts

Insert in the following curl commands the respective usernames like admin , archiveManager and ingestor and set their passwords. These are local accounts defined within the loopback application database

```
curl -X POST --header 'Content-Type: application/json' --header 'Accept:application/json' -d'{"realm":"my.site","username":"...","password":"...!","email":"valid.email@my.site","emailVerified":true}' 'http://localhost:3000/api/v2/Users'

```

# Data models

The data model is defined inside the common/models directory according to the rules defined by the Loopback API framework
The data model is visualized in form of an

[Model UML diagram](http://localhost:3000/modeldiagram) or  
[Model Visualizer](http://localhost:3000/visualize)

# Data Catalog API

## REST API

The REST API can be tested via the [Explorer webpage](http://localhost:3000/explorer)
The [OpenAPI definition](https://www.openapis.org/) can be fetched from  [the Swagger Definition link](http://localhost:3000/explorer/swagger.json)

## Python Client API
The API is automatically created from the Swagger/openAPI (http://swagger.io/) specificication created from the data model using the [Swagger Codegen code](https://github.com/swagger-api/swagger-codegen)

```
java -jar ./swagger-codegen/modules/swagger-codegen-cli/target/swagger-codegen-cli.jar generate -i swagger.json -l python -o dacat-api/client/python
```

See e.g. the [description of Dataset model](https://gitlab.psi.ch/MELANIE/catamel/blob/master/client/python/docs/Dataset.md)

## Angular 2 Client API
The library is generated by the following command
```
./node_modules/.bin/lb-sdk server/server.js  client/angular2/sdk
```

# Authentication
Users are authenticated by loopback built in user accounts and by accounts, which are connected via any of the passport supported strategies, in particular OpenID connected and a direct AD connection

